# ุณุณุชู ูุฏุฑุช ููุดููุฏ ูุถุนุช ูพุดุชุจุงูุงู

## ุฎูุงุตู

ุงู ุณุณุชู ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ู ููุดููุฏ ูุถุนุช ูพุดุชุจุงูุงู ุฑุง ูุฏุฑุช ูโฺฉูุฏ ู ููฺูู ุจู ูพุดุชุจุงูุงู ุงุฌุงุฒู ูโุฏูุฏ ฺฉู ุจู ุตูุฑุช ุฏุณุช ูุถุนุช ุฎูุฏ ุฑุง ุชูุธู ฺฉููุฏ.

## ูุนูุงุฑ ุณุณุชู

### 1. ููุฏูุง ุฌุฏุฏ ุฏุฑ `SupportAgent`

```csharp
// ุฒูุงู ุชูุธู ุฏุณุช ูุถุนุช
public DateTime? ManualStatusSetAt { get; set; }

// ุฒูุงู ุงููุถุง ูุถุนุช ุฏุณุช (4 ุณุงุนุช ุจุนุฏ ุงุฒ ุชูุธู)
public DateTime? ManualStatusExpiry { get; set; }

// ูุถุนุช ุชุดุฎุต ุฏุงุฏู ุดุฏู ุชูุณุท ุณุณุชู
public AgentStatus? AutoDetectedStatus { get; set; }
```

### 2. ุชุดุฎุต ุฎูุฏฺฉุงุฑ ูุถุนุช

ุณุณุชู ุจุฑ ุงุณุงุณ **ุฒูุงู ุขุฎุฑู ูุนุงูุช** ู **ุจุงุฑ ฺฉุงุฑ** ูุถุนุช ุฑุง ุชุดุฎุต ูโุฏูุฏ:

| ุขุณุชุงูู | ูุถุนุช |
|--------|-------|
| ูุนุงูุช < 5 ุฏููู ูพุด | `Available` (ุงฺฏุฑ ุธุฑูุช ุฏุงุฑุฏ) ุง `Busy` |
| ูุนุงูุช ุจู 5-15 ุฏููู | `Away` |
| ูุนุงูุช > 15 ุฏููู | `Offline` |

### 3. ุชูุธู ุฏุณุช ุจุง TTL

ุฒูุงู ฺฉู ูพุดุชุจุงู ูุถุนุช ุฎูุฏ ุฑุง **ุฏุณุช** ุชูุธู ูโฺฉูุฏ:
- ูุถุนุช ุจุฑุง **4 ุณุงุนุช** ูุนุชุจุฑ ุงุณุช
- ุจุนุฏ ุงุฒ ุงููุถุงุ ุณุณุชู ุจู **ุชุดุฎุต ุฎูุฏฺฉุงุฑ** ุจุฑูโฺฏุฑุฏุฏ
- ุฏุฑ UI ููุงุด ุฏุงุฏู ูโุดูุฏ ฺฉู ูุถุนุช "ุฏุณุช" ุงุณุช ู ฺูุฏ ุฏููู ุจุงููุงูุฏู

### 4. Background Service

`AgentStatusMonitorService` ูุฑ **2 ุฏููู** ฺฉุจุงุฑ:
- ูุถุนุชโูุง ุฏุณุช ูููุถ ุดุฏู ุฑุง ุจู ุฎูุฏฺฉุงุฑ ุจุฑูโฺฏุฑุฏุงูุฏ
- ูุถุนุช ุฎูุฏฺฉุงุฑ ุชูุงู ูพุดุชุจุงูุงู ุฑุง ุจูโุฑูุฒุฑุณุงู ูโฺฉูุฏ

### 5. ุซุจุช ูุนุงูุช

ูุนุงูุช ูพุดุชุจุงู ุฏุฑ ููุงุฑุฏ ุฒุฑ ุซุจุช ูโุดูุฏ:
- ุงุชุตุงู ุจู SignalR (`OnConnectedAsync`)
- ุฎูุงูุฏู ูพุงู (`MarkMessageAsRead`)
- ุงุฑุณุงู ูพุงู (ุงุฒ ุทุฑู commands)

## ูุญูู ุงุณุชูุงุฏู

### Backend

#### ุชูุธู ุฏุณุช ูุถุนุช (ุชูุณุท ูพุดุชุจุงู)
```http
POST /api/support/agent/status
Content-Type: application/json

{
  "status": 1  // 0=Available, 1=Busy, 2=Away, 3=Offline
}
```

**ูพุงุณุฎ:**
```json
{
  "status": "Busy",
  "message": "ูุถุนุช ุดูุง ุจู ุตูุฑุช ุฏุณุช ุชูุธู ุดุฏ ู ุชุง 4 ุณุงุนุช ุขูุฏู ูุนุชุจุฑ ุฎูุงูุฏ ุจูุฏ.",
  "expiresAt": "2025-10-13T10:28:15Z"
}
```

#### ุฏุฑุงูุช ุงุทูุงุนุงุช ฺฉุงูู ูุถุนุช
```http
GET /api/support/agent/status-info
```

**ูพุงุณุฎ:**
```json
{
  "currentStatus": "Busy",
  "isManuallySet": true,
  "expiresAt": "2025-10-13T10:28:15Z",
  "timeRemainingMinutes": 237.5,
  "autoDetectedStatus": "Available",
  "lastActivityAt": "2025-10-13T06:25:00Z"
}
```

### Frontend (AgentDashboard)

ูุถุนุช ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ููุงุด ุฏุงุฏู ูโุดูุฏ:

```jsx
// Badge ููุงุด ููุน ูุถุนุช
{statusInfo.isManuallySet && (
  <Badge bg="info">
    ๐ ุฏุณุช: 3ุณ 57ุฏ ุจุงููุงูุฏู
  </Badge>
)}

{!statusInfo.isManuallySet && (
  <Badge bg="secondary">
    โ๏ธ ุฎูุฏฺฉุงุฑ
  </Badge>
)}
```

## ุณูุงุฑููุง ูุฎุชูู

### ุณูุงุฑู 1: ูพุดุชุจุงู ุขููุงู ู ูุนุงู
- ูุนุงูุช: ฺฉูุชุฑ ุงุฒ 5 ุฏููู ูพุด
- ฺุชโูุง ูุนุงู: ฺฉูุชุฑ ุงุฒ ุญุฏุงฺฉุซุฑ ุธุฑูุช
- **ูุถุนุช**: `Available` โ

### ุณูุงุฑู 2: ูพุดุชุจุงู ูพุฑ ูุดุบูู
- ูุนุงูุช: ฺฉูุชุฑ ุงุฒ 5 ุฏููู ูพุด
- ฺุชโูุง ูุนุงู: ุจุฑุงุจุฑ ุง ุจุดุชุฑ ุงุฒ ุญุฏุงฺฉุซุฑ ุธุฑูุช
- **ูุถุนุช**: `Busy` ๐ด

### ุณูุงุฑู 3: ูพุดุชุจุงู ุฏูุฑ ุงุฒ ุณุณุชู
- ูุนุงูุช: ุจู 5 ุชุง 15 ุฏููู ูพุด
- **ูุถุนุช**: `Away` ๐ก

### ุณูุงุฑู 4: ูพุดุชุจุงู ุขููุงู
- ูุนุงูุช: ุจุด ุงุฒ 15 ุฏููู ูพุด
- **ูุถุนุช**: `Offline` โซ
- ฺุชโูุง ูุนุงู ุจู ูพุดุชุจุงู ุฏฺฏุฑ ููุชูู ูโุดููุฏ

### ุณูุงุฑู 5: ุชูุธู ุฏุณุช ูููุช
1. ูพุดุชุจุงู ูุถุนุช ุฑุง ุจู "ูุดุบูู" ุชุบุฑ ูโุฏูุฏ
2. ุณุณุชู: "ูุถุนุช ุฏุณุช ุจุฑุง 4 ุณุงุนุช ุซุจุช ุดุฏ"
3. UI ููุงุด ูโุฏูุฏ: "๐ ุฏุณุช: 3ุณ 59ุฏ ุจุงููุงูุฏู"
4. ุจุนุฏ ุงุฒ 4 ุณุงุนุช: ุฎูุฏฺฉุงุฑ ุจู `Available` ุง `Away` ุจุฑูโฺฏุฑุฏุฏ

## ูุฒุงุง ุณุณุชู

โ **ุชุดุฎุต ููุดููุฏ**: ุจุฏูู ูุงุฒ ุจู ุชูุธู ุฏุณุช ูุฏุงูู
โ **ุงูุนุทุงูโูพุฐุฑ**: ูพุดุชุจุงู ูโุชูุงูุฏ ูููุชุงู ูุถุนุช ุฑุง ุชูุธู ฺฉูุฏ
โ **ุดูุงูุช**: ููุงุด ูุงุถุญ ููุน ูุถุนุช (ุฏุณุช/ุฎูุฏฺฉุงุฑ)
โ **ุจูููโุณุงุฒ**: ุฌููฺฏุฑ ุงุฒ ุงูุชุณุงุจ ุชฺฉุช ุจู ูพุดุชุจุงู ุบุฑูุนุงู
โ **ููุงุณโูพุฐุฑ**: Background Service ูุณุชูู ู ฺฉุงุฑุขูุฏ

## ูพฺฉุฑุจูุฏ

### ุชูุธูุงุช TTL
ุฏุฑ `AgentStatusManager.cs`:
```csharp
private static readonly TimeSpan ManualStatusTTL = TimeSpan.FromHours(4);
```

### ุชูุธูุงุช ุขุณุชุงููโูุง ุชุดุฎุต
```csharp
private static readonly TimeSpan AvailableThreshold = TimeSpan.FromMinutes(5);
private static readonly TimeSpan AwayThreshold = TimeSpan.FromMinutes(15);
```

### ูุงุตูู ุจุฑุฑุณ Background Service
ุฏุฑ `AgentStatusMonitorService.cs`:
```csharp
private static readonly TimeSpan CheckInterval = TimeSpan.FromMinutes(2);
```

## Migration

ููุฏูุง ุฌุฏุฏ ุจู ุฌุฏูู `Support_Agents` ุงุถุงูู ุดุฏูโุงูุฏ:
- `ManualStatusSetAt` (datetime2, nullable)
- `ManualStatusExpiry` (datetime2, nullable)
- `AutoDetectedStatus` (int, nullable)

```bash
# ุงุนูุงู migration
cd src/Infrastructure
dotnet ef database update --startup-project ../Web
```

## ุชุณุช

### ุชุณุช ุฏุณุช:
1. ูุงุฑุฏ ูพูู ูพุดุชุจุงู ุดูุฏ
2. ูุถุนุช ุฑุง ุจู "ูุดุบูู" ุชุบุฑ ุฏูุฏ
3. ุจุฑุฑุณ ฺฉูุฏ ฺฉู Badge "ุฏุณุช" ููุงุด ุฏุงุฏู ุดูุฏ
4. ููุชุธุฑ ุจูุงูุฏ ุชุง 4 ุณุงุนุช ุจฺฏุฐุฑุฏ (ุง TTL ุฑุง ฺฉูุชุงูโุชุฑ ฺฉูุฏ)
5. ุชุงุฏ ฺฉูุฏ ฺฉู ุจู ูุถุนุช "ุฎูุฏฺฉุงุฑ" ุจุฑฺฏุดุชู ุงุณุช

### ูุงฺฏโูุง ููุฏ:
```
๐ Agent Status Monitor Service started
๐ Checking agent statuses...
โ Agent statuses updated successfully
```

## ูฺฉุงุช ุงููุช

โ๏ธ **ููู**: ููุท ูพุดุชุจุงู ุฎูุฏ ูโุชูุงูุฏ ูุถุนุช ุฎูุฏุด ุฑุง ุชุบุฑ ุฏูุฏ
- Endpoint ูุง ุจุง `[Authorize("Agent")]` ูุญุงูุธุช ุดุฏูโุงูุฏ
- `agentId` ุงุฒ JWT token ุงุณุชุฎุฑุงุฌ ูโุดูุฏ

## ุฎุทุงุงุจ

### ฺฺฉ ฺฉุฑุฏู ูุถุนุช ูุนู ฺฉ ูพุดุชุจุงู:
```sql
SELECT 
    UserId,
    AgentStatus,
    ManualStatusSetAt,
    ManualStatusExpiry,
    AutoDetectedStatus,
    LastActivityAt
FROM Support_Agents
WHERE UserId = @userId;
```

### ุจุฑุฑุณ Background Service:
ูุงฺฏโูุง application ุฑุง ฺฺฉ ฺฉูุฏ:
```
grep "Agent Status Monitor" application.log
```

## ุชุบุฑุงุช ุขูุฏู (ูพุดููุงุฏ)

- [ ] ุงุถุงูู ฺฉุฑุฏู ุชูุธูุงุช ุดุฎุตโุณุงุฒ TTL ุจุฑุง ูุฑ ูพุดุชุจุงู
- [ ] ููุชูฺฉุดู ูุจู ุงุฒ ุงููุถุง ูุถุนุช ุฏุณุช (5 ุฏููู ูุจู)
- [ ] Dashboard ูุฏุฑุช ุจุง ุขูุงุฑ ูุถุนุชโูุง ุชุงุฑุฎ
- [ ] ุซุจุช ุชุงุฑุฎฺู ุชุบุฑุงุช ูุถุนุช ุฏุฑ ุฌุฏูู ุฌุฏุงฺฏุงูู
